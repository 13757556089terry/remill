/* Copyright 2015 Peter Goodman (peter@trailofbits.com), all rights reserved. */

namespace {

template <typename T>
DEF_SEM(CALL, T target_pc) {
  CLEAR_AFLAGS();
  *state.gpr.rsp.ptr-- = state.gpr.rip.full;
  state.gpr.rip.full = static_cast<PC>(target_pc);
}

template <typename T>
DEF_SEM(INDIRECT_CALL, T *target_pc) {
  CLEAR_AFLAGS();
  *state.gpr.rsp.ptr-- = state.gpr.rip.full;
  state.gpr.rip.full = static_cast<uintptr_t>(*target_pc);
}

DEF_SEM(RET_IMM, IMM16 bytes) {
  CLEAR_AFLAGS();
  state.gpr.rip.full = *state.gpr.rsp.ptr++;
  state.gpr.rsp.full += bytes;
}

DEF_SEM(RET) {
  CLEAR_AFLAGS();
  state.gpr.rip.full = *state.gpr.rsp.ptr++;
}

}  // namespace

DEF_ISEL_32UP(CALL_NEAR_RELBRz, CALL<PC>);
DEF_ISEL_32UP(CALL_NEAR_RELBRd, CALL<PC>);

DEF_ISEL(CALL_NEAR_MEMv_32) = INDIRECT_CALL<uint32_t>;
DEF_ISEL(CALL_NEAR_MEMv_64) = INDIRECT_CALL<uint64_t>;

DEF_ISEL_Rn(CALL_NEAR_GRPv, CALL);

/*
352 CALL_FAR CALL_FAR_MEMp2 CALL BASE I86 ATTRIBUTES: FAR_XFER FIXED_BASE1 NOTSX SCALABLE STACKPUSH1
353 CALL_FAR CALL_FAR_PTRp_IMMw CALL BASE I86 ATTRIBUTES: FAR_XFER FIXED_BASE0 NOTSX SCALABLE STACKPUSH0

728 IRETD IRETD RET BASE I386 ATTRIBUTES: FIXED_BASE0 NOTSX SCALABLE STACKPOP0
*/

DEF_ISEL_32UP(RET_NEAR_IMMw, RET_IMM);
DEF_ISEL_32UP(RET_NEAR, RET);

/*
1073 RET_FAR RET_FAR_IMMw RET BASE I86 ATTRIBUTES: FAR_XFER FIXED_BASE0 NOTSX SCALABLE STACKPOP0
1074 RET_FAR RET_FAR RET BASE I86 ATTRIBUTES: FAR_XFER FIXED_BASE0 NOTSX SCALABLE STACKPOP0
1666 IRETQ IRETQ RET LONGMODE LONGMODE ATTRIBUTES: FIXED_BASE0 NOTSX SCALABLE STACKPOP0
1784 IRET IRET RET BASE I86 ATTRIBUTES: FIXED_BASE0 NOTSX SCALABLE STACKPOP0
*/
